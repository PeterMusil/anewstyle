---
import Footer from "../components/footer/Footer.astro";
import IconSet from "../components/icons/IconSet.astro";
import CookieBar from "../components/cookies/CookieBar.astro";
import CookieDialog from "../components/cookies/CookieDialog.astro";
import Nav from "../components/nav/Nav.astro";
import {
  getLangFromUrl,
  getAlternateLinks,
  defaultLang,
  type Lang,
} from "../i18n/utils";

interface Props {
  title: string;
  description: string;
  showNav?: boolean;
}

const { title, description, showNav = true } = Astro.props;
const lang = getLangFromUrl(Astro.url) as Lang;
const baseSite = Astro.site ?? new URL(Astro.url.origin);
const canonicalUrl = new URL(Astro.url.pathname, baseSite);
const alternateLinks = getAlternateLinks(canonicalUrl);
const xDefaultHref =
  alternateLinks.find((link) => link.lang === defaultLang)?.href ??
  canonicalUrl.href;
const ogLocale = lang === "cs" ? "cs_CZ" : "en_US";
const ogLocaleAlternate = lang === "cs" ? "en_US" : "cs_CZ";
const googleImageUrl = new URL("/images/meta/meta-google.webp", baseSite).href;
const fbImageUrl = new URL("/images/meta/meta-fb.webp", baseSite).href;
const twitterImageUrl = new URL("/images/meta/meta-twitter.webp", baseSite).href;

// Google Tag Manager (hardcoded ID)
const GTM_ID = 'GTM-WT79RGCG';
const ENABLE_GTM = true;
---

<!doctype html>
<html lang={lang}>
  <head>
    {ENABLE_GTM && (
      // Consent Mode v2 + GTM loader
      <script is:inline>
        // dataLayer + gtag bootstrap
        window.dataLayer = window.dataLayer || [];
        function gtag(){ dataLayer.push(arguments); }

        // Simple cookie helpers for consent
        (function(){
          const KEY = 'cookie-consent-v1';
          function readCookieRaw(name){
            const m = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/([.$?*|{}()\[\]\\\/\+^])/g,'\\$1') + '=([^;]*)'));
            return m ? decodeURIComponent(m[1]) : null;
          }
          function read(){
            try {
              const raw = readCookieRaw(KEY);
              if(!raw) return undefined;
              const obj = JSON.parse(raw);
              if (typeof obj === 'object' && obj) return obj;
            } catch(_){ /* ignore */ }
            return undefined;
          }
          function write(value, update){
            const days = 180; // 6 months
            const maxAge = days * 24 * 60 * 60;
            const secure = location.protocol === 'https:' ? '; Secure' : '';
            document.cookie = KEY + '=' + encodeURIComponent(JSON.stringify(value)) + '; Path=/; Max-Age=' + maxAge + '; SameSite=Lax' + secure;
            if (update) updateGtag(value);
          }
          function toConsentFlags(consent){
            const analytics = consent?.analytics ? 'granted' : 'denied';
            const marketing = consent?.marketing ? 'granted' : 'denied';
            return {
              ad_storage: marketing,
              analytics_storage: analytics,
              ad_user_data: marketing,
              ad_personalization: marketing,
              functionality_storage: 'granted',
              security_storage: 'granted',
            };
          }
          function updateGtag(consent){
            const flags = toConsentFlags(consent || {});
            gtag('consent','update', flags);
          }

          // expose minimal API
          window.__cookieConsent = { read, write, updateGtag, key: KEY };

          // Set default consent BEFORE loading GTM
          const existing = read();
          const defaults = toConsentFlags(existing || {});
          // If no stored consent, default everything optional to denied
          if (!existing) {
            defaults.ad_storage = 'denied';
            defaults.analytics_storage = 'denied';
            defaults.ad_user_data = 'denied';
            defaults.ad_personalization = 'denied';
          }
          gtag('consent', 'default', defaults);
        })();

        // Load GTM after consent defaults are set
        (function(w,d,s,l,i){
          w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(), event:'gtm.js'});
          var f=d.getElementsByTagName(s)[0], j=d.createElement(s), dl=l!='dataLayer'?'&l='+l:''; j.async=true; j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl; f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-WT79RGCG');
      </script>
    )}
    <meta charset="utf-8" />
    <link rel="canonical" href={canonicalUrl.href} />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="author" content="Lukáš Chylík" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <meta name="keywords" content={description} />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/images/favicons/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/images/favicons/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/images/favicons/favicon-16x16.png"
    />
    <link
      rel="mask-icon"
      href="/images/favicons/safari-pinned-tab.svg"
      color="#5bbad5"
    />

    <!-- Alternate language links (hreflang) -->
    {alternateLinks.map(({ lang: altLang, href }) => (
      <link rel="alternate" hreflang={altLang} href={href} />
    ))}
    <link rel="alternate" hreflang="x-default" href={xDefaultHref} />

    <meta name="msapplication-TileColor" content="#111618" />
    <meta name="theme-color" content="#111618" />

    <!-- Schema.org markup for Google -->
    <meta itemprop="name" content={title} />
    <meta itemprop="description" content={description} />
    <meta itemprop="image" content={googleImageUrl} />

    <!-- Open Graph data -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonicalUrl.href} />
    <meta property="og:image" content={fbImageUrl} />
    <meta property="og:locale" content={ogLocale} />
    <meta property="og:locale:alternate" content={ogLocaleAlternate} />

    <!-- Twitter Card data -->
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={twitterImageUrl} />

    <link rel="stylesheet" href="/css/style.css" type="text/css" />

    <meta name="generator" content={Astro.generator} />

    <!-- Store current language for client-side scripts -->
    <script is:inline define:vars={{ lang }}>
      window.__currentLang = lang;
      try {
        if (typeof localStorage !== "undefined") {
          localStorage.setItem("lang", lang);
        }
      } catch (_error) {
      }
    </script>
  </head>
  <body data-lang={lang}>
    {ENABLE_GTM && (
      // Google Tag Manager (noscript)
      <noscript>
        <iframe
          src={`https://www.googletagmanager.com/ns.html?id=${GTM_ID}`}
          height="0"
          width="0"
          style="display:none;visibility:hidden"
        ></iframe>
      </noscript>
    )}
    <CookieBar lang={lang} />
    <CookieDialog lang={lang} />
    <IconSet />
    {showNav && <Nav lang={lang} />}
    <slot />
    <Footer lang={lang} />
  </body>
</html>
