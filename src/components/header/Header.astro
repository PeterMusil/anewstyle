---
import Icon from "../icons/Icon.astro";
---

<header>
  <video
    class="header__video"
    id="headerVideo"
    aria-label="Anew style header video"
    preload="metadata"
    autoplay
    loop
    muted></video>
  <div class="header__content">
    <div>
      <h1>Anew style</h1>
    </div>
    <strong data-localize="header_title"></strong>
    <div class="header__buttons">
      <a
        class="button"
        href="#about"
        id="headerMoreButton"
        aria-label="Přejít na sekci o nás"
        rel="noopener"
        data-localize="header_btn_more"></a>
      <button
        class="button button--secondary"
        id="headerArButton"
        type="button"
        aria-label="Zobrazit v AR u mě doma"
      >
        <span>Zobraz u mňe doma</span>
        <Icon name="ar" iconClass="icon-header" />
      </button>
    </div>
  </div>
</header>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const videoElement = document.querySelector("#headerVideo");
    const screenWidth = window.innerWidth;

    if (screenWidth > 560) {
      const sources = [
        { src: "./videos/main-video.mp4", type: "video/mp4" },
        { src: "./videos/main-video.webm", type: "video/webm" },
        { src: "./videos/main-video.ogv", type: "video/ogg" },
      ];

      videoElement &&
        sources.forEach((source) => {
          let sourceElement = document.createElement("source");
          sourceElement.src = source.src;
          sourceElement.type = source.type;
          videoElement.appendChild(sourceElement);
        });
    } else {
      videoElement && videoElement.remove();
    }

    // AR Button functionality
    const arButton = document.querySelector("#headerArButton");
    if (arButton) {
      arButton.addEventListener("click", () => {
        // Load model-viewer if not already loaded
        if (
          !document.querySelector(
            'script[src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"]'
          )
        ) {
          const script = document.createElement("script");
          script.type = "module";
          script.src =
            "https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js";
          document.body.appendChild(script);

          // Wait for script to load before creating model-viewer
          script.onload = () => {
            createAndShowARModel();
          };
        } else {
          createAndShowARModel();
        }
      });
    }

    function createAndShowARModel() {
      // Create a temporary model-viewer element
      const modelViewer = document.createElement("model-viewer") as any;
      modelViewer.setAttribute(
        "src",
        "./3d/products/Rockfoil_DARKGOLD_3D_vertical.glb"
      );
      modelViewer.setAttribute("ar", "");
      modelViewer.setAttribute("ar-scale", "auto");
      modelViewer.setAttribute("ar-modes", "webxr scene-viewer quick-look");
      modelViewer.setAttribute("camera-controls", "");
      modelViewer.setAttribute("touch-action", "pan-y");
      modelViewer.setAttribute("camera-orbit", "0deg 90deg 2.5m");
      modelViewer.style.position = "fixed";
      modelViewer.style.top = "-9999px";
      modelViewer.style.left = "-9999px";
      modelViewer.style.width = "1px";
      modelViewer.style.height = "1px";
      modelViewer.style.opacity = "0";

      document.body.appendChild(modelViewer);

      // Trigger AR mode immediately
      setTimeout(() => {
        if (modelViewer.activateAR) {
          modelViewer.activateAR();
        }
        // Clean up the temporary element after a delay
        setTimeout(() => {
          if (document.body.contains(modelViewer)) {
            document.body.removeChild(modelViewer);
          }
        }, 1000);
      }, 100);
    }
  });
</script>
