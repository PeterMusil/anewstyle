---
import Icon from "../icons/Icon.astro";
---

<header>
  <video
    class="header__video"
    id="headerVideo"
    aria-label="Anew style header video"
    preload="metadata"
    autoplay
    loop
    muted></video>
  <div class="header__content">
    <div>
      <h1>Anew style</h1>
    </div>
    <strong data-localize="header_title"></strong>
    <div class="header__buttons">
      <a
        class="button"
        href="#about"
        id="headerMoreButton"
        aria-label="Přejít na sekci o nás"
        rel="noopener"
      >
        <span data-localize="header_btn_more"></span>
      </a>
      <!-- E-shop button - visible on desktop only -->
      <a
        class="button button--secondary header__eshop-btn"
        href="https://www.anewstyle-eshop.cz"
        rel="external"
        target="_blank"
        aria-label="Přejít na e-shop"
      >
        <span data-localize="header_btn_eshop"></span>
        <Icon name="eshop" iconClass="icon-header" />
      </a>
      <!-- AR button - visible on tablet and mobile only -->
      <button
        class="button button--secondary header__ar-btn"
        id="headerArButton"
        type="button"
        aria-label="Zobrazit v AR u mě doma"
        data-loading="false"
        data-error="false"
      >
        <span>Zobraz u mňe doma</span>
        <Icon name="ar" iconClass="icon-header" />
      </button>
    </div>
  </div>
</header>

<style>
  /* Desktop: Show e-shop button, hide AR button */
  @media (min-width: 1024px) {
    .header__eshop-btn {
      display: flex;
    }
    .header__ar-btn {
      display: none;
    }
  }

  /* Tablet and mobile: Hide e-shop button, show AR button */
  @media (max-width: 1023px) {
    .header__eshop-btn {
      display: none;
    }
    .header__ar-btn {
      display: flex;
    }
  }

  /* AR button states */
  .header__ar-btn[data-loading="true"] {
    opacity: 0.7;
    cursor: wait;
  }

  .header__ar-btn[data-error="true"] {
    background-color: #ff4444;
    color: white;
  }

  /* Ensure AR model-viewer doesn't interfere with page */
  model-viewer[style*="position: fixed"] {
    visibility: hidden !important;
    pointer-events: none !important;
    user-select: none !important;
    z-index: -9999 !important;
  }
</style>

<script>
  import "@google/model-viewer";

  // AR functionality with proper Android support
  async function activateARForModel(modelPath: string): Promise<void> {
    try {
      // Create model-viewer element
      const modelViewer = document.createElement("model-viewer") as any;

      // Set attributes for AR
      modelViewer.setAttribute("src", modelPath);
      modelViewer.setAttribute("ar", "");
      modelViewer.setAttribute("ar-scale", "auto");
      modelViewer.setAttribute("ar-modes", "webxr scene-viewer quick-look");
      modelViewer.setAttribute("camera-controls", "");
      modelViewer.setAttribute("touch-action", "pan-y");
      modelViewer.setAttribute("camera-orbit", "0deg 90deg 2.5m");
      modelViewer.setAttribute("loading", "eager");

      // Position off-screen but keep it accessible for AR
      modelViewer.style.position = "fixed";
      modelViewer.style.top = "-1px";
      modelViewer.style.left = "-1px";
      modelViewer.style.width = "1px";
      modelViewer.style.height = "1px";
      modelViewer.style.opacity = "0";
      modelViewer.style.pointerEvents = "none";
      modelViewer.style.zIndex = "-1";

      // Add to DOM
      document.body.appendChild(modelViewer);

      // Wait for model to load
      await new Promise<void>((resolve, reject) => {
        const timeout = setTimeout(() => {
          reject(new Error("Model load timeout"));
        }, 10000);

        const onLoad = () => {
          clearTimeout(timeout);
          resolve();
        };

        const onError = (error: any) => {
          clearTimeout(timeout);
          reject(error);
        };

        // Listen for load events
        modelViewer.addEventListener("load", onLoad, { once: true });
        modelViewer.addEventListener("error", onError, { once: true });

        // Also check if already loaded
        if (modelViewer.loaded) {
          clearTimeout(timeout);
          resolve();
        }
      });

      // Wait a bit more to ensure everything is ready
      await new Promise((resolve) => setTimeout(resolve, 300));

      // Activate AR
      if (typeof modelViewer.activateAR === "function") {
        modelViewer.activateAR();
      } else {
        throw new Error("AR activation not available");
      }

      // Set up cleanup when AR session ends
      const cleanup = () => {
        if (document.body.contains(modelViewer)) {
          document.body.removeChild(modelViewer);
        }
      };

      // Listen for AR session end events
      modelViewer.addEventListener("ar-status", (event: any) => {
        if (event.detail.status === "not-presenting") {
          // AR session ended, clean up after a delay
          setTimeout(cleanup, 1000);
        }
      });

      // Fallback cleanup after 30 seconds (in case AR session doesn't end properly)
      setTimeout(cleanup, 30000);
    } catch (error) {
      console.error("Failed to activate AR:", error);
      throw error;
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    // Video initialization
    const videoElement = document.querySelector(
      "#headerVideo"
    ) as HTMLVideoElement;
    const screenWidth = window.innerWidth;

    if (screenWidth > 560 && videoElement) {
      const sources = [
        { src: "./videos/main-video.mp4", type: "video/mp4" },
        { src: "./videos/main-video.webm", type: "video/webm" },
        { src: "./videos/main-video.ogv", type: "video/ogg" },
      ];

      sources.forEach((source) => {
        const sourceElement = document.createElement("source");
        sourceElement.src = source.src;
        sourceElement.type = source.type;
        videoElement.appendChild(sourceElement);
      });
    } else if (videoElement) {
      videoElement.remove();
    }

    // AR button initialization
    const arButton = document.querySelector(
      "#headerArButton"
    ) as HTMLButtonElement;

    if (!arButton) {
      console.warn("AR button not found");
      return;
    }

    arButton.addEventListener("click", async () => {
      try {
        // Show loading state
        arButton.disabled = true;
        arButton.setAttribute("data-loading", "true");

        // Activate AR
        await activateARForModel(
          "./3d/products/Rockfoil_DARKGOLD_3D_vertical.glb"
        );

        // Restore button state
        arButton.disabled = false;
        arButton.setAttribute("data-loading", "false");
      } catch (error) {
        console.error("AR activation failed:", error);

        // Show error state
        arButton.disabled = false;
        arButton.setAttribute("data-loading", "false");
        arButton.setAttribute("data-error", "true");

        // Reset error state after 2 seconds
        setTimeout(() => {
          arButton.setAttribute("data-error", "false");
        }, 2000);
      }
    });
  });
</script>
