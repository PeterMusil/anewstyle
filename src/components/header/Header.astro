---
import Icon from "../icons/Icon.astro";
---

<header>
  <video
    class="header__video"
    id="headerVideo"
    aria-label="Anew style header video"
    preload="metadata"
    autoplay
    loop
    muted></video>
  <div class="header__content">
    <div>
      <h1>Anew style</h1>
    </div>
    <strong data-localize="header_title"></strong>
    <div class="header__buttons">
      <a
        class="button"
        href="#about"
        data-loading="true"
        id="headerMoreButton"
        aria-label="Přejít na sekci o nás"
        rel="noopener"
      >
        <span data-localize="header_btn_more"></span>
      </a>
      <!-- E-shop button - visible on desktop only -->
      <a
        class="button button--secondary header__eshop-btn"
        href="https://www.anewstyle-eshop.cz"
        rel="external"
        target="_blank"
        aria-label="Přejít na e-shop"
      >
        <span data-localize="header_btn_eshop"></span>
        <Icon name="eshop" iconClass="icon-header" />
      </a>
      <!-- AR button - visible on tablet and mobile only -->
      <button
        class="button button--secondary header__ar-btn"
        id="headerArButton"
        type="button"
        aria-label="Zobrazit v AR u mě doma"
        data-loading="false"
        data-error="false"
      >
        <span data-localize="header_btn_ar"></span>
        <Icon name="ar" iconClass="icon-header" />
      </button>
    </div>
  </div>
</header>

<script>
  import "@google/model-viewer";

  // AR functionality inlined to avoid import issues
  async function activateARForModel(modelPath: string): Promise<void> {
    try {
      // Create model-viewer element
      const modelViewer = document.createElement("model-viewer") as any;

      // Set attributes
      modelViewer.setAttribute("src", modelPath);
      modelViewer.setAttribute("ar", "");
      modelViewer.setAttribute("ar-scale", "auto");
      modelViewer.setAttribute("ar-modes", "webxr scene-viewer quick-look");
      modelViewer.setAttribute("camera-controls", "");
      modelViewer.setAttribute("touch-action", "pan-y");
      modelViewer.setAttribute("camera-orbit", "0deg 90deg 2.5m");

      // Position element for AR (Android needs visible element)
      modelViewer.style.position = "fixed";
      modelViewer.style.top = "50%";
      modelViewer.style.left = "50%";
      modelViewer.style.width = "300px";
      modelViewer.style.height = "300px";
      modelViewer.style.transform = "translate(-50%, -50%)";
      modelViewer.style.zIndex = "9999";
      modelViewer.style.backgroundColor = "rgba(0,0,0,0.8)";
      modelViewer.style.borderRadius = "10px";

      // Add to DOM
      document.body.appendChild(modelViewer);

      // Wait for model-viewer to be ready
      await new Promise<void>((resolve, reject) => {
        const timeout = setTimeout(() => {
          reject(new Error("Model load timeout"));
        }, 10000);

        const checkReady = () => {
          if (typeof modelViewer.activateAR === "function") {
            clearTimeout(timeout);
            resolve();
          } else {
            setTimeout(checkReady, 100);
          }
        };
        checkReady();

        modelViewer.addEventListener(
          "load",
          () => {
            clearTimeout(timeout);
            resolve();
          },
          { once: true }
        );

        modelViewer.addEventListener(
          "error",
          (error: any) => {
            clearTimeout(timeout);
            reject(error);
          },
          { once: true }
        );
      });

      // Check if AR is available
      if (!modelViewer.canActivateAR) {
        throw new Error("AR is not supported on this device");
      }

      // Activate AR
      await modelViewer.activateAR();

      // Add loading text
      const loadingText = document.createElement("div");
      loadingText.style.position = "absolute";
      loadingText.style.top = "50%";
      loadingText.style.left = "50%";
      loadingText.style.transform = "translate(-50%, -50%)";
      loadingText.style.color = "white";
      loadingText.style.fontSize = "16px";
      loadingText.style.fontWeight = "bold";
      loadingText.textContent = "Loading AR...";
      modelViewer.appendChild(loadingText);

      // Add close button
      const closeButton = document.createElement("button");
      closeButton.style.position = "absolute";
      closeButton.style.top = "10px";
      closeButton.style.right = "10px";
      closeButton.style.background = "rgba(255,255,255,0.8)";
      closeButton.style.border = "none";
      closeButton.style.borderRadius = "50%";
      closeButton.style.width = "30px";
      closeButton.style.height = "30px";
      closeButton.style.cursor = "pointer";
      closeButton.textContent = "×";
      closeButton.onclick = () => {
        if (document.body.contains(modelViewer)) {
          document.body.removeChild(modelViewer);
        }
      };
      modelViewer.appendChild(closeButton);

      // Clean up after AR activation
      setTimeout(() => {
        if (document.body.contains(modelViewer)) {
          document.body.removeChild(modelViewer);
        }
      }, 2000);
    } catch (error) {
      console.error("Failed to activate AR:", error);
      throw error;
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    // Video initialization
    const videoElement = document.querySelector(
      "#headerVideo"
    ) as HTMLVideoElement;
    const screenWidth = window.innerWidth;

    if (screenWidth > 560 && videoElement) {
      const sources = [
        { src: "./videos/main-video.mp4", type: "video/mp4" },
        { src: "./videos/main-video.webm", type: "video/webm" },
        { src: "./videos/main-video.ogv", type: "video/ogg" },
      ];

      sources.forEach((source) => {
        const sourceElement = document.createElement("source");
        sourceElement.src = source.src;
        sourceElement.type = source.type;
        videoElement.appendChild(sourceElement);
      });
    } else if (videoElement) {
      videoElement.remove();
    }

    // AR button initialization
    const arButton = document.querySelector(
      "#headerArButton"
    ) as HTMLButtonElement;

    if (!arButton) {
      console.warn("AR button not found");
      return;
    }

    arButton.addEventListener("click", async () => {
      try {
        // Show loading state
        arButton.disabled = true;
        arButton.setAttribute("data-loading", "true");

        // Activate AR
        await activateARForModel(
          "./3d/products/Rockfoil_DARKGOLD_3D_vertical.glb"
        );

        // Restore button state
        arButton.disabled = false;
        arButton.setAttribute("data-loading", "false");
      } catch (error) {
        console.error("AR activation failed:", error);

        // Show error state
        arButton.disabled = false;
        arButton.setAttribute("data-loading", "false");
        arButton.setAttribute("data-error", "true");

        // Reset error state after 2 seconds
        setTimeout(() => {
          arButton.setAttribute("data-error", "false");
        }, 2000);
      }
    });
  });
</script>
