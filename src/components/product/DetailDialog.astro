---
import Icon from "../icons/Icon.astro";
import { useTranslations, type Lang } from "../../i18n/utils";
interface Props {
  id: number;
  title?: string;
  desc?: string;
  descEn?: string;
  imgDark?: string;
  imgFrame?: string;
  imgLight?: string;
  modelHorizontal3d?: string;
  modelVertical3d?: string;
  daeFile?: string;
  price?: number;
  reservation: boolean;
  lang?: Lang;
  tags: {
    dimension: string;
    weight: string;
    maxConsumption: string;
    standbyConsumption: string;
    brightness: string;
    backlightTempereture: string;
    powerVoltage: string;
    frameColor: string;
    hangingBrackets: boolean;
    dimmableStoneIllumination: boolean;
    dimmableIllumination: boolean;
    phoneControl: boolean;
    LEDSource: boolean;
    RFIDController: boolean;
    RFRemoteControl: boolean;
    nanoImpregnation: boolean;
    divisibleInto2: boolean;
    divisibleInto3: boolean;
  };
}
const {
  id,
  title,
  desc,
  descEn,
  price,
  imgDark,
  imgFrame,
  imgLight,
  modelHorizontal3d,
  modelVertical3d,
  daeFile,
  reservation,
  lang = "cs",
  tags,
} = Astro.props;

const t = useTranslations(lang);

const currentDescription = lang === "en" ? descEn : desc;

const primaryFancyboxHref = modelHorizontal3d
  ? `#horizontal3dModel${id}`
  : modelVertical3d
    ? `#vertical3dModel${id}`
    : `/images/products/${imgLight}`;
---

<dialog id={`myDialog${id}`} class="dialog">
  <button
    type="button"
    id="closeBtn"
    class="dialog__close"
    aria-label={t("products.closeDetail")}
    title={t("products.closeDetail")}
  >
    <Icon name="close" />
  </button>
  <div class="product-detail">
    <strong>{title}</strong>
    <div class="product-detail__img" title={t("products.showIn3d")}>
      <a
        href={primaryFancyboxHref}
        aria-label={t("products.stoneAsLighting")}
        data-fancybox={`product${id}`}
      >
        <img
          src={`/images/products/${imgLight}`}
          alt={`${t("products.stoneAsLighting")} ${title ?? ""}`.trim()}
          width="1024"
          id="closeImg"
        />
        {(modelHorizontal3d || modelVertical3d) && <Icon name="ar" />}
      </a>
    </div>
    <div class="product-detail__hidden">
      {
        modelVertical3d && (
          <a
            href={`#vertical3dModel${id}`}
            aria-label={t("products.stoneAsLighting")}
            data-fancybox={`product${id}`}
          />
        )
      }
      {
        imgDark && (
          <a
            href={`/images/products/${imgDark}`}
            aria-label={t("products.stoneAsLighting")}
            data-fancybox={`product${id}`}
          />
        )
      }
      {
        imgFrame && (
          <a
            href={`/images/products/${imgFrame}`}
            aria-label={t("products.stoneAsLighting")}
            data-fancybox={`product${id}`}
          />
        )
      }
      {
        imgLight && (
          <a
            href={`/images/products/${imgLight}`}
            aria-label={t("products.stoneAsLighting")}
            data-fancybox={`product${id}`}
          />
        )
      }
      {
        modelHorizontal3d && (
          <model-viewer
            id={`horizontal3dModel${id}`}
            src={`/3d/products/${modelHorizontal3d}`}
            ar
            ar-scale="auto"
            ar-modes="webxr scene-viewer quick-look"
            camera-controls
            touch-action="pan-y"
            camera-orbit="0deg 90deg 2.5m"
          />
        )
      }
      {
        modelVertical3d && (
          <model-viewer
            id={`vertical3dModel${id}`}
            src={`/3d/products/${modelVertical3d}`}
            ar
            ar-scale="auto"
            ar-modes="webxr scene-viewer quick-look"
            camera-controls
            touch-action="pan-y"
            camera-orbit="0deg 90deg 2.5m"
          />
        )
      }
    </div>
    <div class="product-detail__content">
      {
        currentDescription && (
          <p class="desc desc--no-mg">{currentDescription}</p>
        )
      }
      <div class="tags">
        <ul>
          {
            tags.dimension && (
              <li>
                <span>{t("products.tagDimension")}</span>
                <b>{tags.dimension}</b>
              </li>
            )
          }
          {
            tags.weight && (
              <li>
                <span>{t("products.tagWeight")}</span>
                <b>{tags.weight}</b>
              </li>
            )
          }
          {
            tags.maxConsumption && (
              <li>
                <span>{t("products.tagMaxCons")}</span>
                <b>{tags.maxConsumption}</b>
              </li>
            )
          }
          {
            tags.standbyConsumption && (
              <li>
                <span>{t("products.tagStandbyCons")}</span>
                <b>{tags.standbyConsumption}</b>
              </li>
            )
          }
          {
            tags.brightness && (
              <li>
                <span>{t("products.tagBrightness")}</span>
                <b>{tags.brightness}</b>
              </li>
            )
          }
          {
            tags.backlightTempereture && (
              <li>
                <span>{t("products.tagBacklightTemp")}</span>
                <b>{tags.backlightTempereture}</b>
              </li>
            )
          }
          {
            tags.powerVoltage && (
              <li>
                <span>{t("products.tagPowerVoltage")}</span>
                <b>{tags.powerVoltage}</b>
              </li>
            )
          }
          {
            tags.frameColor && (
              <li>
                <span>{t("products.tagFrameColor")}</span>
                <b>{tags.frameColor}</b>
              </li>
            )
          }
          {
            tags.hangingBrackets && (
              <li>
                <span>{t("products.tagHang")}</span>
              </li>
            )
          }
          {
            tags.dimmableStoneIllumination && (
              <li>
                <b>{t("products.tagDimmableStoneIll")}</b>
              </li>
            )
          }
          {
            tags.dimmableIllumination && (
              <li>
                <b>{t("products.tagDimmableIll")}</b>
              </li>
            )
          }
          {
            tags.phoneControl && (
              <li>
                <b>{t("products.tagPhoneControl")}</b>
              </li>
            )
          }
          {
            tags.LEDSource && (
              <li>
                <b>{t("products.tagLed")}</b>
              </li>
            )
          }
          {
            tags.RFIDController && (
              <li>
                <b>{t("products.tagRfidController")}</b>
              </li>
            )
          }
          {
            tags.RFRemoteControl && (
              <li>
                <b>{t("products.tagRfRemote")}</b>
              </li>
            )
          }
          {
            tags.nanoImpregnation && (
              <li>
                <b>{t("products.tagImpregnation")}</b>
              </li>
            )
          }
          {
            tags.divisibleInto2 && (
              <li>
                <b>{t("products.tagDivisible2")}</b>
              </li>
            )
          }
          {
            tags.divisibleInto3 && (
              <li>
                <b>{t("products.tagDivisible3")}</b>
              </li>
            )
          }
          <li>
            <button id="showMoreTags" type="button" class="button button--xs">
              <span>{t("products.detailBtnMore")}</span>
              <span>{t("products.detailBtnLess")}</span>
            </button>
          </li>
        </ul>
      </div>

      <div class="product-detail__footer">
        {
          daeFile && (
            <a
              href={`/downloads/dae/${daeFile}`}
              target="_blank"
              class="link link--light link--uppercase"
            >
              <Icon name="download" />
              <span>{t("products.detailDownload")}</span>
            </a>
          )
        }
        <a
          class="button button--s"
          href="mailto:info@anewstyle.cz"
          aria-disabled={reservation}
        >
          <span>{t("products.detailBtnInterested")}</span>
          <Icon name="email" />
        </a>
      </div>
    </div>
  </div>

  <script>
    const products = document.querySelectorAll(".product");
    const body = document.querySelector("body");

    products.forEach((product) => {
      const productCard = product.querySelector('div[role="button"]');
      const productDetail = product.querySelector("dialog");
      if (!(productCard instanceof HTMLElement)) return;
      if (!(productDetail instanceof HTMLDialogElement)) return;

      const closeBtn = productDetail.querySelector("#closeBtn");
      if (!(closeBtn instanceof HTMLButtonElement)) return;

      const closeDialog = () => {
        productDetail.close();
        body?.style.setProperty("overflow", "initial");
      };

      productCard.addEventListener("click", () => {
        productDetail.showModal();
        body?.style.setProperty("overflow", "hidden");

        if (
          !document.querySelector(
            'script[src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"]'
          )
        ) {
          const script = document.createElement("script");
          script.type = "module";
          script.src =
            "https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js";

          document.body.appendChild(script);
        }
      });

      closeBtn.addEventListener("click", (event) => {
        event.stopPropagation();
        closeDialog();
      });

      productDetail.addEventListener("click", (event) => {
        if (event.target !== productDetail) return;
        closeDialog();
      });

      const tagList = productDetail.querySelector(".tags");
      if (!(tagList instanceof HTMLElement)) return;

      const showMoreBtn = tagList.querySelector("button#showMoreTags");
      if (!(showMoreBtn instanceof HTMLButtonElement)) return;

      const spanMore = showMoreBtn.querySelector("span:nth-child(1)");
      const spanLess = showMoreBtn.querySelector("span:nth-child(2)");
      if (!(spanMore instanceof HTMLSpanElement)) return;
      if (!(spanLess instanceof HTMLSpanElement)) return;

      spanLess.style.display = "none";

      showMoreBtn.addEventListener("click", () => {
        tagList.classList.toggle("tags--all");
        const isAll = tagList.classList.contains("tags--all");
        spanMore.style.display = isAll ? "none" : "inline";
        spanLess.style.display = isAll ? "inline" : "none";
      });
    });
  </script>
</dialog>
