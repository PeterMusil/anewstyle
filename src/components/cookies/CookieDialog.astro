---
// Cookie preferences dialog using native <dialog>
---

<dialog
  id="cookie-preferences-dialog"
  class="cookie-dialog"
  aria-labelledby="cookie-dialog-title"
  aria-describedby="cookie-dialog-desc"
  aria-modal="true"
>
  <form method="dialog" class="cookie-dialog__box">
    <div
      class="cookie-dialog__header"
      role="group"
      aria-label="Cookie dialog header"
    >
      <h2 id="cookie-dialog-title" class="cookie-dialog__title">
        <span data-localize="cookie_dialog_title"></span>
      </h2>
      <button
        type="button"
        class="cookie-dialog__close"
        id="cookie-dialog-close"
        aria-label="Close"
        aria-controls="cookie-preferences-dialog"
        aria-keyshortcuts="Escape"
      >
        âœ•
      </button>
    </div>

    <div class="cookie-dialog__content">
      <p id="cookie-dialog-desc" class="cookie-dialog__desc">
        <span data-localize="cookie_dialog_desc"></span>
      </p>

      <fieldset class="cookie-dialog__group">
        <legend
          class="cookie-dialog__legend"
          data-localize="cookie_categories_legend"></legend>

        <label class="cookie-option">
          <input type="checkbox" id="consent-analytics" />
          <span>
            <strong data-localize="cookie_category_analytics"></strong>
            <small data-localize="cookie_category_analytics_desc"></small>
          </span>
        </label>

        <label class="cookie-option">
          <input type="checkbox" id="consent-marketing" />
          <span>
            <strong data-localize="cookie_category_marketing"></strong>
            <small data-localize="cookie_category_marketing_desc"></small>
          </span>
        </label>

        <div class="cookie-option cookie-option--disabled" aria-disabled="true">
          <input type="checkbox" checked disabled />
          <span>
            <strong data-localize="cookie_category_necessary"></strong>
            <small data-localize="cookie_category_necessary_desc"></small>
          </span>
        </div>
      </fieldset>

      <div class="cookie-dialog__legal">
        <p>
          <span data-localize="cookie_dialog_legal"></span>
        </p>
      </div>
    </div>

    <div
      class="cookie-dialog__footer"
      role="group"
      aria-label="Cookie dialog actions"
    >
      <button
        type="button"
        class="button button--secondary button--xs"
        id="cookie-save-prefs"
        ><span data-localize="cookie_btn_save_prefs"></span></button
      >
      <div class="cookie-dialog__spacer"></div>
      <button
        type="button"
        class="button button--transparent button--xs"
        id="cookie-reject-all-dlg"
        ><span data-localize="cookie_btn_reject_all"></span></button
      >
      <button type="button" class="button button--xs" id="cookie-accept-all-dlg"
        ><span data-localize="cookie_btn_accept_all"></span></button
      >
    </div>
  </form>
</dialog>

<script>
  const dlg = document.getElementById(
    "cookie-preferences-dialog"
  ) as HTMLDialogElement;
  const closeBtn = document.getElementById(
    "cookie-dialog-close"
  ) as HTMLButtonElement;
  const analyticsCb = document.getElementById(
    "consent-analytics"
  ) as HTMLInputElement;
  const marketingCb = document.getElementById(
    "consent-marketing"
  ) as HTMLInputElement;
  const saveBtn = document.getElementById(
    "cookie-save-prefs"
  ) as HTMLButtonElement;
  const rejectAllBtn = document.getElementById(
    "cookie-reject-all-dlg"
  ) as HTMLButtonElement;
  const acceptAllBtn = document.getElementById(
    "cookie-accept-all-dlg"
  ) as HTMLButtonElement;
  let prevBodyOverflow: string | null = null;

  function openDialog() {
    try {
      // @ts-ignore
      const existing = window.__cookieConsent?.read();
      analyticsCb.checked = !!existing?.analytics;
      marketingCb.checked = !!existing?.marketing;
    } catch (_) {
      analyticsCb.checked = false;
      marketingCb.checked = false;
    }
    dlg.showModal();
    // lock background scroll
    const body = document.body as HTMLBodyElement;
    prevBodyOverflow = body.style.overflow || "";
    body.style.overflow = "hidden";
  }

  function savePrefsFromInputs() {
    const consent = {
      necessary: true,
      analytics: !!analyticsCb.checked,
      marketing: !!marketingCb.checked,
    };
    // @ts-ignore
    window.__cookieConsent?.write(consent, true);
    window.dispatchEvent(new CustomEvent("cookie-consent-updated"));
    dlg.close();
  }

  // External open trigger
  window.addEventListener("open-cookie-dialog", openDialog);
  // Provide a simple global hook too
  // @ts-ignore
  window.__openCookieDialog = openDialog;

  closeBtn?.addEventListener("click", () => dlg.close());
  saveBtn?.addEventListener("click", savePrefsFromInputs);

  rejectAllBtn?.addEventListener("click", () => {
    analyticsCb.checked = false;
    marketingCb.checked = false;
    savePrefsFromInputs();
  });

  acceptAllBtn?.addEventListener("click", () => {
    analyticsCb.checked = true;
    marketingCb.checked = true;
    savePrefsFromInputs();
  });

  // Restore scroll on all dialog dismiss paths
  function restoreBodyScroll() {
    const body = document.body as HTMLBodyElement;
    body.style.overflow = prevBodyOverflow ?? "";
  }
  dlg?.addEventListener("close", restoreBodyScroll);
  // @ts-ignore
  dlg?.addEventListener("cancel", (e) => {
    // Some browsers fire 'cancel' when pressing ESC
    restoreBodyScroll();
  });
</script>
