---
import { useTranslations, type Lang } from "../../i18n/utils";

interface Props {
  lang?: Lang;
}

const { lang = 'cs' } = Astro.props;
const t = useTranslations(lang);
---

<div id="cookie-consent-banner" class="cookie-banner" aria-live="polite" role="dialog" aria-modal="false" aria-label={t('cookie.consent')}>
  <div class="cookie-banner__content">
    <p class="cookie-banner__text">
      <span>{t('cookie.bannerText')}</span>
    </p>
    <div class="cookie-banner__actions">
      <button type="button" class="button button--xs" id="cookie-reject-all"><span>{t('cookie.btnRejectAll')}</span></button>
      <button type="button" class="button button--xs" id="cookie-accept-all"><span>{t('cookie.btnAcceptAll')}</span></button>
      <button type="button" class="button button--transparent button--xs" id="cookie-customize"><span>{t('cookie.btnCustomize')}</span></button>
    </div>
  </div>
</div>



<script>
  const BANNER_ID = "cookie-consent-banner";
  const banner = document.getElementById(BANNER_ID) as HTMLDivElement;
  const acceptBtn = document.getElementById("cookie-accept-all") as HTMLButtonElement;
  const rejectBtn = document.getElementById("cookie-reject-all") as HTMLButtonElement;
  const customizeBtn = document.getElementById("cookie-customize") as HTMLButtonElement;

  function shouldShowBanner(): boolean {
    try {
      // @ts-ignore
      const hasConsent = !!window.__cookieConsent?.read();
      return !hasConsent;
    } catch (_) {
      return true;
    }
  }

  function hideBanner() {
    banner.style.display = "none";
    banner.setAttribute("aria-hidden", "true");
  }

  function showBanner() {
    banner.style.display = "block";
    banner.setAttribute("aria-hidden", "false");
  }

  // Show banner on load if consent missing
  document.addEventListener("DOMContentLoaded", () => {
    if (shouldShowBanner()) showBanner();
  });

  // Also hide when consent is updated elsewhere (e.g., dialog)
  window.addEventListener("cookie-consent-updated", hideBanner);

  acceptBtn?.addEventListener("click", () => {
    // @ts-ignore
    window.__cookieConsent?.write({ necessary: true, analytics: true, marketing: true }, true);
    hideBanner();
    window.dispatchEvent(new CustomEvent("cookie-consent-updated"));
  });

  rejectBtn?.addEventListener("click", () => {
    // @ts-ignore
    window.__cookieConsent?.write({ necessary: true, analytics: false, marketing: false }, true);
    hideBanner();
    window.dispatchEvent(new CustomEvent("cookie-consent-updated"));
  });

  customizeBtn?.addEventListener("click", () => {
    // Let the dialog decide whether to keep banner visible
    window.dispatchEvent(new CustomEvent("open-cookie-dialog"));
  });
</script>
